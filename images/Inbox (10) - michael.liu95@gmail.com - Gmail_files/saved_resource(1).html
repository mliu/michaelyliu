<!DOCTYPE html>
<!-- saved from url=(0064)https://mail.google.com/mail/u/0/?ui=2&view=bsp&ver=ohhl4rw8mbn4 -->
<html><script type="text/javascript">(function () {
      return window.SIG_EXT = {};
    })()</script><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><style type="text/css"></style></head><body></body><script type="text/javascript">(function () {
      var DataParser, XHR, generateUUID, getUrlVars, open, send, sendMsg, sendParentMsg;
      window.SIG_inject = {};
      window["__bind"] = function(fn, me) {
        return function() {
          return fn.apply(me, arguments);
        };
      };
      window.SIG_inject.getUserKey = function() {
        window.addEventListener("message", (function(event) {
          if (event.source !== window) {
            return;
          }
          if (!event.data.type) {
            return;
          }
          if (event.data.type === "XHR_USER_KEY_RESPONSE") {
            window.SIG_inject.user_key = event.data.user_key;
            window.SIG_inject.bcc_email = event.data.bcc_email;
            window.SIG_inject.host = event.data.host;
            window.SIG_inject.domain = event.data.domain;
            window.SIG_inject.all_domains = event.data.all_domains;
          }
        }), false);
        window.postMessage({
          type: "XHR_USER_KEY_REQUEST"
        }, "*");
        if ((window.GLOBALS != null) && (window.GLOBALS[10] != null)) {
          window.postMessage({
            type: "XHR_EMAIL_DETECTION",
            email: window.GLOBALS[10]
          }, "*");
          window.parent.postMessage({
            type: "XHR_EMAIL_DETECTION",
            email: window.GLOBALS[10]
          }, "*");
        }
      };
      window.SIG_inject.getUserKey();
      generateUUID = function() {
        var d, uuid;
        d = new Date().getTime();
        uuid = "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g, function(c) {
          var r;
          r = (d + Math.random() * 16) % 16 | 0;
          d = Math.floor(d / 16);
          return (c === "x" ? r : r & 0x7 | 0x8).toString(16);
        });
        return uuid;
      };
      sendMsg = function(type, data) {
        return window.postMessage({
          type: type,
          tracker_data: data
        }, "*");
      };
      sendParentMsg = function(type, data) {
        return window.parent.postMessage({
          type: type,
          tracker_data: data
        }, "*");
      };
      getUrlVars = function(url) {
        var hash, hashes, i, vars;
        vars = [];
        hash = void 0;
        hashes = url.slice(url.indexOf("?") + 1).split("&");
        i = 0;
        while (i < hashes.length) {
          hash = hashes[i].split("=");
          if (!vars.hasOwnProperty(hash[0])) {
            if (hash[1] !== "") {
              vars[hash[0]] = [hash[1]];
            } else {
              vars[hash[0]] = [];
            }
          } else {
            if (hash[1] !== "") {
              vars[hash[0]].push(hash[1]);
            }
          }
          i++;
        }
        return vars;
      };
      DataParser = (function() {
        function DataParser(url_hash, post_hash) {
          this.getEmailData = __bind(this.getEmailData, this);
          this.extractEmail = __bind(this.extractEmail, this);
          this.replacePostValue = __bind(this.replacePostValue, this);
          this.generateSendLaterSubject = __bind(this.generateSendLaterSubject, this);
          this.getSendLaterData = __bind(this.getSendLaterData, this);
          this.getSendLaterTimeStamp = __bind(this.getSendLaterTimeStamp, this);
          this.getguser = __bind(this.getguser, this);
          this.url_hash = url_hash;
          this.post_hash = post_hash;
          this;
        }

        DataParser.prototype.getguser = function() {
          var _ref;
          if ((window.GLOBALS != null) && (window.GLOBALS[10] != null)) {
            return window.GLOBALS[10];
          } else {
            return unescape((_ref = this.post_hash['from']) != null ? _ref[0] : void 0);
          }
        };

        DataParser.prototype.getSendLaterTimeStamp = function() {
          var d;
          d = null;
          if (this.post_hash.signals_send_later != null) {
            d = new Date(parseInt(this.post_hash.signals_send_later));
            if (!isNaN(d)) {
              return d;
            } else {
              return null;
            }
          }
        };

        DataParser.prototype.getSendLaterData = function() {
          var email_data, _ref;
          email_data = this.getEmailData(false);
          email_data['to'] = (_ref = email_data['to']) != null ? _ref.map((function(_this) {
            return function(email) {
              return _this.extractEmail(email);
            };
          })(this)) : void 0;
          email_data['from'] = this.getguser();
          email_data['signals_subject'] = this.generateSendLaterSubject(email_data.subject);
          email_data['send_later'] = unescape(this.post_hash.signals_send_later[0]);
          if (this.post_hash.signals_send_later_final != null) {
            email_data['send_later_final'] = unescape(this.post_hash.signals_send_later_final[0]);
          }
          return email_data;
        };

        DataParser.prototype.generateSendLaterSubject = function(subject) {
          var lower, max, min, new_subject, rand_int;
          lower = subject.toLowerCase();
          if (lower.indexOf("re:") === -1 && lower.indexOf("fwd:") === -1) {
            return subject;
          }
          max = 10000;
          min = 1;
          rand_int = Math.floor(Math.random() * (max - min + 1)) + min;
          new_subject = subject + (" (Signals-Scheduled-" + rand_int + ")");
          return new_subject;
        };

        DataParser.prototype.replacePostValue = function(postData, elem, new_value) {
          var regex;
          new_value = encodeURIComponent(new_value);
          regex = new RegExp("(" + elem + "=)[^\&]*");
          postData = postData.replace(regex, '$1' + new_value);
          return postData;
        };

        DataParser.prototype.extractEmail = function(str) {
          var regex, result;
          if (str == null) {
            return null;
          }
          regex = /([a-zA-Z0-9._-]+@[a-zA-Z0-9._-]+\.[a-zA-Z0-9._-]+)/gi;
          result = str.match(regex);
          return result != null ? result[0] : void 0;
        };

        DataParser.prototype.getEmailData = function(full) {
          var email_data;
          if (full == null) {
            full = true;
          }
          email_data = {};
          if (full) {
            if (window.gmail_detected_email != null) {
              email_data.from_email = this.getguser();
            } else if (this.post_hash.hasOwnProperty('from')) {
              email_data.from_email = unescape(this.post_hash['from'][0]);
            } else {
              email_data.from_email = null;
            }
            if (this.post_hash.signals_template_id != null) {
              email_data.template_id = parseInt(this.post_hash.signals_template_id);
            }
          }
          email_data.subject = decodeURIComponent(this.post_hash.subject[0]);
          email_data.to = this.post_hash.to.map(function(address) {
            return unescape(address);
          });
          email_data.cc = this.post_hash.cc.map(function(address) {
            return unescape(address);
          });
          email_data.bcc = this.post_hash.bcc.map(function(address) {
            return unescape(address);
          });
          return email_data;
        };

        return DataParser;

      })();
      XHR = XMLHttpRequest.prototype;
      open = XHR.open;
      send = XHR.send;
      XHR.open = function(method, url) {
        this._method = method;
        this._url = url;
        return open.apply(this, arguments);
      };
      return XHR.send = function(postData) {
        var addition, address, bcc_addr, bcc_checked, bcc_email, bcc_used, body, body_replaced, chosen_link_domain, chosen_open_domain, data_parser, do_not_wrap, draft, email_data, encoded_uri, err, found_old_tracker, has_checkbox, html_mode, index, len, link_data, link_obj, links, match, new_bcc, new_body, new_compose, new_subject, new_url, no_wrap_urls, num, original_url, parsed_body, post_hash, previous_body, regex, send_later_status, temp_elem, tracker_data, tracker_url, tracking, ukey, urlRegex, url_hash, xhr_obj, _i, _j, _len;
        xhr_obj = this;
        try {
          if ((this._url != null) && (Object.prototype.toString.call(this._url) === "[object String]")) {
            url_hash = getUrlVars(this._url);
            draft = url_hash.hasOwnProperty('autosave');
            if (url_hash.hasOwnProperty('act')) {
              draft = draft || (url_hash.act[0] === 'sd');
            }
            send_later_status = null;
            this._send_later_data = null;
            if (draft === true) {
              post_hash = getUrlVars(postData);
              if ((post_hash.signals_send_later != null) && post_hash.signals_send_later !== "") {
                if ((post_hash.signals_send_later_final != null) && post_hash.signals_send_later_final[0] === 'true') {
                  send_later_status = 'found';
                } else {
                  send_later_status = 'pending';
                }
                post_hash = getUrlVars(postData);
                data_parser = new DataParser(url_hash, post_hash);
                this._send_later_data = data_parser.getSendLaterData();
              }
            }
            if (url_hash.hasOwnProperty('rid') && (draft === false || (send_later_status != null))) {
              if (post_hash == null) {
                post_hash = getUrlVars(postData);
              }
              if (post_hash.hasOwnProperty('to') && post_hash.hasOwnProperty('body')) {
                if (data_parser == null) {
                  data_parser = new DataParser(url_hash, post_hash);
                }
                chosen_open_domain = window.SIG_inject.domain;
                chosen_link_domain = window.SIG_inject.domain;
                has_checkbox = post_hash.hasOwnProperty('signals_tracked');
                if (!has_checkbox) {
                  console.log("SIGNALS: Not Tracking Checkbox!");
                  window.postMessage({
                    type: "XHR_NOT_TRACKED"
                  }, "*");
                }
                tracking = has_checkbox && (post_hash.signals_tracked[0] === 'true');
                bcc_checked = has_checkbox && (post_hash.signals_bcc[0] === 'true');
                html_mode = post_hash.ishtml[0] === '1';
                if (draft === false || send_later_status === 'found') {
                  console.log("SIGNALS: sent an email. Tracking: " + tracking + ". HTML: " + html_mode);
                  bcc_used = (window.SIG_inject.bcc_email != null) && bcc_checked;
                  if (bcc_used === true) {
                    console.log("Using BCC: " + window.SIG_inject.bcc_email);
                    bcc_addr = post_hash.bcc.map(function(address) {
                      return unescape(address);
                    });
                    bcc_email = window.SIG_inject.bcc_email;
                    bcc_addr.push(bcc_email);
                    new_bcc = encodeURIComponent(bcc_addr);
                    postData = postData.replace(/(bcc=)[^\&]*/, '$1' + new_bcc);
                  }
                  if (tracking && html_mode) {
                    console.log("SIGNALS: tracking email.");
                    ukey = window.SIG_inject.user_key;
                    new_compose = post_hash.hasOwnProperty('uet');
                    email_data = data_parser.getEmailData();
                    body = post_hash.body[0];
                    body_replaced = false;
                    parsed_body = unescape(body);
                    previous_body = parsed_body;
                    if (new_compose && post_hash.uet.length > 0) {
                      previous_body = previous_body + " " + unescape(post_hash.uet[0]);
                    }
                    regex = new RegExp("(" + ukey + ")&(?:amp;)?key=([0-9A-z-]*)");
                    match = previous_body.match(regex);
                    found_old_tracker = match != null;
                    if (found_old_tracker) {
                      email_data.key = match[2];
                      console.log("SIGNALS: Found existing tracker: " + email_data.key);
                    } else {
                      email_data.key = generateUUID();
                    }
                    if (!found_old_tracker) {
                      tracker_url = chosen_open_domain + ("/img.gif?ukey=" + ukey + "&amp;key=" + email_data.key);
                      addition = "<img src='" + tracker_url + "' width ='1' height ='1' style='display:none'>";
                      index = new_compose ? body.length - 12 : body.length;
                      new_body = body.slice(0, index) + escape(addition) + body.slice(index);
                      body_replaced = true;
                    } else {
                      new_body = body;
                    }
                    link_data = [];
                    parsed_body = decodeURIComponent(new_body);
                    temp_elem = document.createElement('div');
                    temp_elem.innerHTML = parsed_body;
                    links = temp_elem.getElementsByTagName('a');
                    len = links.length - 1;
                    if (len >= 0) {
                      for (num = _i = 0; 0 <= len ? _i <= len : _i >= len; num = 0 <= len ? ++_i : --_i) {
                        urlRegex = /((http|https):\/\/(\w+:{0,1}\w*@)?(\S+)|)(:[0-9]+)?(\/|\/([\w#!:.?+=&%@!\-\/]))?/;
                        original_url = links[num].href;
                        no_wrap_urls = ["signalscrx.appspot.com/link", "app.getsignals.com/link", "mailto:", "tel:"];
                        no_wrap_urls = no_wrap_urls.concat(window.SIG_inject.all_domains);
                        do_not_wrap = false;
                        for (_j = 0, _len = no_wrap_urls.length; _j < _len; _j++) {
                          address = no_wrap_urls[_j];
                          do_not_wrap = ((original_url.indexOf(address)) !== -1) || do_not_wrap;
                        }
                        if ((urlRegex.test(original_url)) && (do_not_wrap === false)) {
                          link_obj = {};
                          link_obj.key = generateUUID();
                          link_obj.url = original_url;
                          link_data.push(link_obj);
                          encoded_uri = encodeURIComponent(original_url);
                          new_url = chosen_link_domain + ("/link?url=" + encoded_uri + "&ukey=" + ukey + "&k=" + link_obj.key);
                          links[num].href = new_url;
                        }
                      }
                      new_body = encodeURIComponent(temp_elem.innerHTML);
                      body_replaced = true;
                    }
                    if (body_replaced) {
                      postData = postData.replace(/(body=)[^\&]+/, '$1' + new_body);
                    }
                    tracker_data = {
                      email_data: email_data,
                      link_data: link_data
                    };
                    this._tracker_data = tracker_data;
                  }
                }
                if (send_later_status === 'found') {
                  new_subject = this._send_later_data.signals_subject;
                  console.debug("REPLACING SUBJECT " + new_subject);
                  postData = data_parser.replacePostValue(postData, 'subject', new_subject);
                }
                xhr_obj.addEventListener("load", function() {
                  var draft_id, err, search_str, start, str, substr;
                  try {
                    str = this.responseText.toString();
                    if (send_later_status != null) {
                      search_str = 'our message has been saved.",["';
                    } else {
                      search_str = 'our message has been sent.",["';
                    }
                    start = str.indexOf(search_str) + search_str.length;
                    substr = str.substring(start, start + 25);
                    match = substr.match(/[0-9A-z]*/);
                    if (match) {
                      draft_id = match[0];
                      if (this._tracker_data != null) {
                        this._tracker_data.email_data.gmail_id = draft_id;
                      }
                      if (this._send_later_data != null) {
                        this._send_later_data.draft_id = draft_id;
                      }
                    }
                    if (this._tracker_data != null) {
                      sendMsg("XHR_RESPONSE", this._tracker_data);
                    }
                    if (this._send_later_data != null) {
                      sendParentMsg("XHR_SEND_LATER", this._send_later_data);
                    }
                  } catch (_error) {
                    err = _error;
                    console.log(err.message);
                  }
                });
              }
            }
          }
        } catch (_error) {
          err = _error;
          console.error(err.message);
          console.log(err);
        }
        return send.apply(this, arguments);
      };
    })()</script></html>